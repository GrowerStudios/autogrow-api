<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Panel RabbiTotem - CRUD</title>
<style>
  body { font-family: Arial, sans-serif; margin: 18px; }
  .header-row { display:flex; align-items:center; justify-content:space-between; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
  th { background:#f3f3f3; font-weight:600; }
  input[type="number"], input[type="text"] { width: 110px; padding:4px; }
  button { padding:6px 8px; margin:0 4px; }
  .small { font-size:0.9em; color:#333; }
  #createForm { margin-top:10px; padding:8px; border:1px solid #eee; display:none; }
  .actions { white-space:nowrap; }
</style>
</head>
<body>
  <h1>Panel RabbiTotem</h1>

  <!-- Valores actuales (último registro) -->
  <h2>Valores actuales</h2>
  <table>
    <thead>
      <tr><th>Temperatura (°C)</th><th>Humedad (%)</th><th>Fecha</th></tr>
    </thead>
    <tbody id="currentValuesBody">
      <tr><td colspan="3">Cargando...</td></tr>
    </tbody>
  </table>

  <!-- Setpoint actual -->
  <h2>Setpoint actual</h2>
  <table>
    <thead>
      <tr><th>Temp Set (°C)</th><th>Hum Set (%)</th></tr>
    </thead>
    <tbody id="setpointBody">
      <tr><td colspan="2">Cargando...</td></tr>
    </tbody>
  </table>

  <div style="margin-top:8px;">
    <h3>Modificar Setpoint</h3>
    <label>Temperatura: <input type="number" id="setTemp" step="0.1" /></label>
    <label style="margin-left:10px;">Humedad: <input type="number" id="setHum" step="0.1" /></label>
    <button id="btnUpdateSet">Enviar</button>
    <span id="updateStatus" class="small"></span>
  </div>

  <hr style="margin:18px 0;">

  <!-- Lista de registros + botón agregar -->
  <div class="header-row">
    <h2 style="margin:0;">Lista de registros</h2>
    <div>
      <button id="btnToggleCreate">Agregar registro</button>
    </div>
  </div>

  <!-- Formulario crear (oculto por defecto) -->
  <div id="createForm">
    <label>Temp: <input type="number" id="newTemp" step="0.01" /></label>
    <label style="margin-left:8px;">Hum: <input type="number" id="newHum" step="0.01" /></label>
    <label style="margin-left:8px;">Timestamp (opcional): <input type="text" id="newTimestamp" placeholder="YYYY-MM-DD HH:MM:SS" /></label>
    <button id="btnCreate">Crear</button>
    <span id="createStatus" class="small"></span>
  </div>

  <!-- Tabla de registros -->
  <table>
    <thead>
      <tr><th>ID</th><th>Temp (°C)</th><th>Hum (%)</th><th>Timestamp</th><th>Acciones</th></tr>
    </thead>
    <tbody id="logTableBody">
      <tr><td colspan="5">Cargando...</td></tr>
    </tbody>
  </table>

<script>
const API_BASE = "https://autogrow-api-mbmc.onrender.com/api";

// ---------- HELPERS ----------
function safeDisplay(v) {
  // normaliza null / "null" / undefined -> ''
  if (v === null || v === undefined) return '';
  if (typeof v === 'string' && v.toLowerCase() === 'null') return '';
  return v;
}
function toNumberFromInput(raw) {
  // acepta "44.22" o "44,22"
  if (typeof raw !== 'string') raw = String(raw || '');
  raw = raw.trim().replace(',', '.');
  if (raw === '') return NaN;
  const n = parseFloat(raw);
  return n;
}

// ---------- Último registro ----------
async function fetchLatestLog() {
  try {
    const res = await fetch(`${API_BASE}/log`);
    const data = await res.json();
    const registros = Array.isArray(data.registros) ? data.registros : [];

    const tbody = document.getElementById('currentValuesBody');
    tbody.innerHTML = '';
    if (registros.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3">Sin registros</td></tr>';
      return;
    }

    // ordenar descendente y tomar el más reciente
    registros.sort((a,b) => b[0] - a[0]);
    const [id, tempRaw, humRaw, fechaRaw] = registros[0];

    const temp = safeDisplay(tempRaw);
    const hum  = safeDisplay(humRaw);
    const fecha = safeDisplay(fechaRaw);

    tbody.innerHTML = `<tr>
      <td>${temp}</td>
      <td>${hum}</td>
      <td>${fecha}</td>
    </tr>`;
  } catch (err) {
    console.error('fetchLatestLog error', err);
    document.getElementById('currentValuesBody').innerHTML = '<tr><td colspan="3">Error</td></tr>';
  }
}

// ---------- Setpoint ----------
async function getSetpoint() {
  try {
    const res = await fetch(`${API_BASE}/setpoint`);
    const data = await res.json();
    const t = data && (data.temp_set ?? data.temp ?? null);
    const h = data && (data.hum_set ?? data.hum ?? null);
    document.getElementById('setpointBody').innerHTML = `<tr>
      <td>${safeDisplay(t)}</td>
      <td>${safeDisplay(h)}</td>
    </tr>`;
    // precargar inputs de edición
    document.getElementById('setTemp').value = safeDisplay(t);
    document.getElementById('setHum').value = safeDisplay(h);
  } catch (err) {
    console.error('getSetpoint error', err);
    document.getElementById('setpointBody').innerHTML = '<tr><td colspan="2">Error</td></tr>';
  }
}

document.getElementById('btnUpdateSet').addEventListener('click', async () => {
  const statusEl = document.getElementById('updateStatus');
  statusEl.textContent = '';
  const rawT = String(document.getElementById('setTemp').value || '').trim();
  const rawH = String(document.getElementById('setHum').value || '').trim();

  const t = toNumberFromInput(rawT);
  const h = toNumberFromInput(rawH);

  if (!Number.isFinite(t) || !Number.isFinite(h)) {
    statusEl.textContent = 'Temp y Hum deben ser números válidos.';
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/setpoint`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ temp_set: t, hum_set: h })
    });
    if (res.ok) {
      statusEl.textContent = 'Setpoint actualizado.';
      await getSetpoint();
    } else {
      statusEl.textContent = 'Error actualizando setpoint.';
    }
  } catch (err) {
    console.error('updateSetpoint error', err);
    statusEl.textContent = 'Error de red.';
  }
});

// ---------- Lista de registros ----------
async function loadLogs() {
  try {
    const res = await fetch(`${API_BASE}/log`);
    const data = await res.json();
    const registros = Array.isArray(data.registros) ? data.registros : [];
    registros.sort((a,b) => b[0] - a[0]);

    const tbody = document.getElementById('logTableBody');
    tbody.innerHTML = '';
    if (registros.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5">Sin registros</td></tr>';
      return;
    }

    registros.forEach(item => {
      const [id, tempRaw, humRaw, timeRaw] = item;
      const temp = safeDisplay(tempRaw);
      const hum = safeDisplay(humRaw);
      const time = safeDisplay(timeRaw);

      const tr = document.createElement('tr');
      tr.setAttribute('data-id', id);
      tr.innerHTML = `
        <td>${id}</td>
        <td class="temp-cell">${temp}</td>
        <td class="hum-cell">${hum}</td>
        <td class="time-cell">${time}</td>
        <td class="actions">
          <button onclick="editRow(${id})">Editar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error('loadLogs error', err);
    document.getElementById('logTableBody').innerHTML = '<tr><td colspan="5">Error cargando registros</td></tr>';
  }
}

// ---------- Edit / Save / Delete ----------
function editRow(id) {
  const row = document.querySelector(`#logTableBody tr[data-id="${id}"]`);
  if (!row) return;
  const tempText = row.querySelector('.temp-cell').textContent || '';
  const humText  = row.querySelector('.hum-cell').textContent  || '';
  const timeText = row.querySelector('.time-cell').textContent || '';

  // crear inputs (vacío si antes era null)
  row.querySelector('.temp-cell').innerHTML = `<input id="temp-${id}" type="number" step="0.01" value="${tempText || ''}">`;
  row.querySelector('.hum-cell').innerHTML  = `<input id="hum-${id}" type="number" step="0.01" value="${humText || ''}">`;
  row.querySelector('.time-cell').innerHTML = `<input id="time-${id}" type="text" value="${timeText || ''}">`;

  row.querySelector('.actions').innerHTML = `
    <button onclick="saveRow(${id})">Guardar</button>
    <button onclick="deleteRow(${id})">Borrar</button>
  `;
}

async function saveRow(id) {
  // leer crudo y normalizar
  const rawT = String(document.getElementById(`temp-${id}`).value || '').trim();
  const rawH = String(document.getElementById(`hum-${id}`).value || '').trim();
  const rawTime = String(document.getElementById(`time-${id}`).value || '').trim();

  // parseo robusto (acepta "44,22" y " 44.22 ")
  const t = toNumberFromInput(rawT);
  const h = toNumberFromInput(rawH);

  // validación agresiva: bloquear si no son números
  if (!Number.isFinite(t) || !Number.isFinite(h)) {
    alert('Temp y Hum deben ser números válidos antes de guardar. No envies campos vacíos.');
    return;
  }

  // construir body sólo con valores adecuados
  const body = { temp: t, hum: h };
  if (rawTime !== '') body.timestamp = rawTime;

  // LOG del payload antes de enviar para debug (ver DevTools / RapidAPI)
  console.log('PUT payload ->', JSON.stringify(body));

  try {
    const res = await fetch(`${API_BASE}/log/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (res.ok) {
      await loadLogs();
      await fetchLatestLog();
    } else {
      // leer texto de error si existe
      const errText = await res.text().catch(()=>null);
      console.error('saveRow - server error', res.status, errText);
      alert('Error actualizando registro en servidor.');
    }
  } catch (err) {
    console.error('saveRow error', err);
    alert('Error de red al guardar.');
  }
}


async function deleteRow(id) {
  if (!confirm(`¿Seguro que querés eliminar el registro ID ${id}?`)) return;
  try {
    const res = await fetch(`${API_BASE}/log/${id}`, { method: 'DELETE' });
    if (res.ok) {
      await loadLogs();
      await fetchLatestLog();
    } else {
      alert('Error eliminando registro.');
    }
  } catch (err) {
    console.error('deleteRow error', err);
    alert('Error de red al eliminar.');
  }
}

// ---------- Crear registro ----------
document.getElementById('btnToggleCreate').addEventListener('click', () => {
  const c = document.getElementById('createForm');
  c.style.display = (c.style.display === 'none' || c.style.display === '') ? 'block' : 'none';
});

document.getElementById('btnCreate').addEventListener('click', async () => {
  const status = document.getElementById('createStatus');
  status.textContent = '';
  const rawT = String(document.getElementById('newTemp').value || '').trim();
  const rawH = String(document.getElementById('newHum').value || '').trim();
  const rawTime = String(document.getElementById('newTimestamp').value || '').trim();

  const t = toNumberFromInput(rawT);
  const h = toNumberFromInput(rawH);

  if (!Number.isFinite(t) || !Number.isFinite(h)) {
    status.textContent = 'Temp y Hum deben ser números válidos.';
    return;
  }

  const body = { temperatura: t, humedad: h };
  if (rawTime !== '') body.timestamp = rawTime;

  console.log('POST payload ->', JSON.stringify(body));

  try {
    const res = await fetch(`${API_BASE}/log`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (res.ok) {
      status.textContent = 'Registro creado.';
      document.getElementById('newTemp').value = '';
      document.getElementById('newHum').value = '';
      document.getElementById('newTimestamp').value = '';
      document.getElementById('createForm').style.display = 'none';
      await loadLogs();
      await fetchLatestLog();
    } else {
      const errText = await res.text().catch(()=>null);
      console.error('create error', res.status, errText);
      status.textContent = 'Error creando registro.';
    }
  } catch (err) {
    console.error('createLog error', err);
    status.textContent = 'Error de red al crear registro.';
  }
});

// ---------- Inicialización ----------
fetchLatestLog();
getSetpoint();
loadLogs();
// refrescar último registro periódicamente
setInterval(fetchLatestLog, 30000);
</script>
</body>
</html>
